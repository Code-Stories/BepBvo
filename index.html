<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Editor</title>
  <style type="text/css" media="screen">
    html, body {
      overflow: hidden;
      padding:0;
      margin:0;
    }

    #editor {
      margin: 0;
      position: absolute;
      top: 50px;
      bottom: 0;
      left: 0;
      width: 50%;
    }


    #VCode-editor {
      margin: 0;
      position: absolute;
      top: 50px;
      bottom: 0;
      right: 0;
      left:50%;
      width: 50%;
      height:40%;
    }


    #D3-canvas {
      margin:5px;
      position:absolute;
      top:50%;
      bottom:0;
      right:0;
      left:50%;
      width: 50%;
    }

    nav {
      background-color: #2196F3;
      height: 50px;
    }

    nav ul.controls{
      list-style: none;
      margin:0;
      padding:0;
      height: 100%;
    }

    nav ul.controls li{
      float:left;
      height: 100%;
    }

    nav ul.controls li button{
      background-color: #90CAF9;
      width: 100px;
      height: 100%;
      border: none;
      margin:0;
      color:#FFFFFF;
      font-size: 15px;
      outline:none;
    }

    nav ul.controls li button:active{
      background-color: #1565C0;
    }

    nav ul.controls li button:disabled{
      background-color: #B0BEC5;
    }

    #D3-canvas {
      border-style: solid;
    border-width: 5px;  
    }

  </style>

</head>

<body>

  <nav>
    <ul class="controls">
      <li>
        <button  onclick="parseButton()">Parse</button>
      </li>
      <li>
        <button onclick="stepButton()" id="stepButton" disabled="disabled">Step</button>
      </li>
      <li>
        <button onclick="playButton()" id="playButton" disabled="disabled">Play</button>
      </li>
      <li>
        <button onclick="runButton()" id="runButton" disabled="disabled">Run</button>
      </li>
      <li>
        
        <button id="drop_zone" onclick="import_file()">Import</button>
        
        </li>
      <li>
        <button onclick="export_file()" id="exportButton" disabled="disabled">Export</button>
      </li>
    </ul>
  </nav>
  <textarea id="code" style="display:none;"></textarea>
  <pre id="editor" >
import a file
  </pre>

    <pre id="VCode-editor" >
aap
  </pre>


  <div id='D3-canvas'></div>

  <script src="libs/interpreter/acorn.js"></script>
  <script src="libs/interpreter/interpreter.js"></script>
  <script src="libs/interpreter/vcode_handler.js"></script>
  <script src="libs/converter.js"></script>
  <script src="libs/editor-ace/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>    
  <script src="libs/graphics/D3/d3.js"></script>
  <script src="libs/interpreter/walk.js" type="text/javascript"></script>
  <script>

      
    //Width and height
    var canvas = document.querySelector('#D3-canvas');
    var w = canvas.offsetWidth -15;
    var h = canvas.offsetHeight -15;
    
    //Create SVG element
    var svg = d3.select("#D3-canvas")
          .append("svg")
          .attr("width", w)
          .attr("height", h);

    //Create editor    
    var VCode_editor = ace.edit("VCode-editor");
    VCode_editor.getSession().setMode("ace/mode/javascript");

    //Create editor    
    var editor = ace.edit("editor");   
    editor.getSession().setMode("ace/mode/javascript");
    
    //Get node closest to cursor and make a selection on that node
    var selectNode = function(e,selection){
      console.log(arguments);
      var session = editor.getSession();
      var cursor = selection.getCursor();
      var tree = myInterpreter.ast;
      console.log(cursor);
      var pos = session.getDocument().positionToIndex(cursor,0);
      console.log(pos);
      var node = acorn.walk.findNodeAround(tree, pos,function(a,b){return true;}).node;
      if(node.VCode){
        VCode_editor.setValue(node.VCode);
      } else{
        VCode_editor.setValue("//no vcode defined")
      }

      var range = {};
      range.start = {};
      range.end = {};
      range.start.row = node.loc.start.line - 1 ;
      range.start.column = node.loc.start.column;
      range.end.row = node.loc.end.line - 1;
      range.end.column = node.loc.end.column;

      editor.getSession().selection.setSelectionRange(range);
    }; 
    editor.getSession().selection.on("changeCursor", selectNode)



    var myInterpreter;
    function initAlert(interpreter, scope) {
      var wrapper = function(text) {
        text = text ? text.toString() : '';
        return interpreter.createPrimitive(alert(text));
      };
      interpreter.setProperty(scope, 'alert',
          interpreter.createNativeFunction(wrapper));
    };

      function parseButton() {
      document.getElementById('code').value = editor.getValue();
      var code = document.getElementById('code').value;
      myInterpreter = new Interpreter(code, initAlert);
      disable('');
    
         }

    function stepButton() {
      var range = {
        start: {
          row: 0,
          column: 0
        },
        end: {
          row: 0,
          column: 0
        }
      }

      if (myInterpreter.stateStack[0]) {
        var node = myInterpreter.stateStack[0].node;
        range.start.row = node.loc.start.line - 1 ;
        range.start.column = node.loc.start.column;
        range.end.row = node.loc.end.line - 1;
        range.end.column = node.loc.end.column;
      } 

      editor.getSession().selection.setSelectionRange(range);
      try {
        var ok = myInterpreter.step();
      } finally {
        if (!ok) {
          disable('disabled');
        }
      }
    }

    function playButton() {
      myInterpreter.runToVCode();
    }

    function runButton() {

        myInterpreter.run();

    }

    function disable(disabled) {
      document.getElementById('stepButton').disabled = disabled;
      document.getElementById('runButton').disabled = disabled;
      document.getElementById('playButton').disabled = disabled;
      document.getElementById('exportButton').disabled = disabled;
    }

    function createSelection(start, end) {
      var field = document.getElementById('code')
      if (field.createTextRange) {
        var selRange = field.createTextRange();
        selRange.collapse(true);
        selRange.moveStart('character', start);
        selRange.moveEnd('character', end);
        selRange.select();
      } else if (field.setSelectionRange) {
        field.setSelectionRange(start, end);
      } else if (field.selectionStart) {
        field.selectionStart = start;
        field.selectionEnd = end;
      }
      field.focus();
    }
  </script>

  <script src="libs/file_manager.js"></script>

</body>
</html>
