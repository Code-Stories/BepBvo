<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Editor</title>
  <style type="text/css" media="screen">
    html, body {
        overflow: hidden;
        padding:0;
        margin:0;
    }

    #editor {
        margin: 0;
        position: absolute;
        top: 50px;
        bottom: 0;
        left: 0;
        right: 0;
    }

    nav {
      background-color: #2196F3;
      height: 50px;
    }

    nav ul.controls{
      list-style: none;
      margin:0;
      padding:0;
      height: 100%;
    }

    nav ul.controls li{
      float:left;
      height: 100%;
    }

    nav ul.controls li button{
      background-color: #90CAF9;
      width: 100px;
      height: 100%;
      border: none;
      margin:0;
      color:#FFFFFF;
      font-size: 15px;
      outline:none;
    }

    nav ul.controls li button:active{
      background-color: #1565C0;
    }

    nav ul.controls li button:disabled{
      background-color: #B0BEC5;
    }

  </style>

</head>

<body>

  <nav>
    <ul class="controls">
      <li>
        <button  onclick="parseButton()">Parse</button>
      </li>
      <li>
        <button onclick="stepButton()" id="stepButton" disabled="disabled">Step</button>
      </li>
      <li>
        <button onclick="runButton()" id="runButton" disabled="disabled">Run</button>
      </li>
    </ul>
  </nav>
  <textarea id="code" style="display:none;"></textarea>
  <pre id="editor">
var a = [34, 203, 3, 746, 200, 984, 198, 764, 9];
 
function bubbleSort(a)
{
    var swapped;
    do {
        swapped = false;
        for (var i=0; i < a.length-1; i++) {
            if (a[i] > a[i+1]) {
                var temp = a[i];
                a[i] = a[i+1];
                a[i+1] = temp;
                swapped = true;
            }
        }
    } while (swapped);
}
 
bubbleSort(a);
  </pre>


  <div id='D3-canvas'></div>

  <script src="libs/interpreter/acorn.js"></script>
  <script src="libs/interpreter/interpreter.js"></script>
  <script src="libs/converter.js"></script>
  <script src="libs/editor-ace/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>    
  <script src="libs/graphics/D3/d3.js"></script>

  <script>

      
    //Width and height
    var w = 500;
    var h = 100;
    
    //Create SVG element
    var svg = d3.select("body")
          .append("svg")
          .attr("width", w)
          .attr("height", h);

    //Create editor    
    var editor = ace.edit("editor");
    editor.getSession().setMode("ace/mode/javascript");
    console.log(editor.getValue());

    var myInterpreter;
    function initAlert(interpreter, scope) {
      var wrapper = function(text) {
        text = text ? text.toString() : '';
        return interpreter.createPrimitive(alert(text));
      };
      interpreter.setProperty(scope, 'alert',
          interpreter.createNativeFunction(wrapper));
    };

  var displayArrayCode = 'svg.selectAll("rect").data(scope.a).enter().append("rect").attr("y",function(d){return h-d}).attr("x",function(d,i){return i*21})' +
   '.attr("height",function(d){return d;}).attr("width",20).style("fill","blue")';
   var highlightSelectionCode = 'svg.selectAll("rect").style("fill","blue").filter(function(d,i){return i==scope.i|| i==scope.i+1;}).style("fill","red");'
   var switchCode = 'svg.selectAll("rect").data(scope.a).filter(function(d,i){return i==scope.i|| i==scope.i+1;}).transition().style("fill","green").attr("y",function(d){return h-d}).attr("height",function(d){return d;});';
    function parseButton() {
      document.getElementById('code').value = editor.getValue();
      var code = document.getElementById('code').value;
      myInterpreter = new Interpreter(code, initAlert);
      disable('');
     
      //var swapped
      myInterpreter.ast.body[1].body.body[0].VCode = displayArrayCode;

      // if(a[i] > a[i+1])
      myInterpreter.ast.body[1].body.body[1].body.body[1].body.body[0].test.VCode =highlightSelectionCode;

      // swapped = true inside IF
      myInterpreter.ast.body[1].body.body[1].body.body[1].body.body[0].consequent.body[3].VCode = switchCode;
         }

    function stepButton() {
      var range = {
        start: {
          row: 0,
          column: 0
        },
        end: {
          row: 0,
          column: 0
        }
      }

      if (myInterpreter.stateStack[0]) {
        var node = myInterpreter.stateStack[0].node;
        range.start.row = node.loc.start.line - 1 ;
        range.start.column = node.loc.start.column;
        range.end.row = node.loc.end.line - 1;
        range.end.column = node.loc.end.column;
      } 

      editor.getSession().selection.setSelectionRange(range);
      try {
        var ok = myInterpreter.step();
      } finally {
        if (!ok) {
          disable('disabled');
        }
      }
    }

    function runButton() {

        myInterpreter.run();

    }

    function disable(disabled) {
      document.getElementById('stepButton').disabled = disabled;
      document.getElementById('runButton').disabled = disabled;
    }

    function createSelection(start, end) {
      var field = document.getElementById('code')
      if (field.createTextRange) {
        var selRange = field.createTextRange();
        selRange.collapse(true);
        selRange.moveStart('character', start);
        selRange.moveEnd('character', end);
        selRange.select();
      } else if (field.setSelectionRange) {
        field.setSelectionRange(start, end);
      } else if (field.selectionStart) {
        field.selectionStart = start;
        field.selectionEnd = end;
      }
      field.focus();
    }
  </script>

</body>
</html>
